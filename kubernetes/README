## AWS account info: ## Set environment variables in terminal

export CLUSTER_NAME=otel-demo-cluster
export AWS_REGION=us-east-1
export ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

echo "Cluster: $CLUSTER_NAME | Region: $AWS_REGION | Account: $ACCOUNT_ID"

### Instructions to deploy EKS cluster with CloudFormation ###
aws cloudformation create-stack \
  --stack-name ${CLUSTER_NAME}-stack \
  --template-body file://eks-infra.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region $AWS_REGION

##Wait for the Stack state to become CREATE_COMPLETE

aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_REGION

kubectl get nodes

# Governance & Role-Based Access Control (RBAC)

kubectl apply -f governance.yaml

kubectl get ns --show-labels

kubectl get role,rolebinding -n dev

#Configuring IAM Permissions and Controllers
#Here we will install the Load Balancer Controller and Cluster Autoscaler.


# get VPC ID
export VPC_ID=$(aws eks describe-cluster \
    --name $CLUSTER_NAME \
    --region $AWS_REGION \
    --query "cluster.resourcesVpcConfig.vpcId" \
    --output text)

#Install the AWS Load Balancer Controller

curl -o iam_policy_latest.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json

aws iam create-policy --policy-name AWSLoadBalancerControllerIAMPolicy --policy-document file://iam_policy_latest.json || true

# Create a service account for the AWS Load Balancer Controller (IRSA)

eksctl create iamserviceaccount \
  --cluster=$CLUSTER_NAME \
  --namespace=kube-system \
  --name=aws-load-balancer-controller \
  --role-name AmazonEKSLoadBalancerControllerRole \
  --attach-policy-arn=arn:aws:iam::${ACCOUNT_ID}:policy/AWSLoadBalancerControllerIAMPolicy \
  --override-existing-serviceaccounts \
  --approve \
  --region=$AWS_REGION

# Install the AWS Load Balancer Controller using Helm

helm repo add eks https://aws.github.io/eks-charts
helm repo update

helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=$CLUSTER_NAME \
  --set serviceAccount.create=false \
  --set serviceAccount.name=aws-load-balancer-controller \
  --set region=$AWS_REGION \
  --set vpcId=$VPC_ID

# Install the Cluster Autoscaler

#create the IAM policy for the Cluster Autoscaler

cat <<EOF > cluster-autoscaler-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "autoscaling:DescribeAutoScalingGroups",
                "autoscaling:DescribeAutoScalingInstances",
                "autoscaling:DescribeLaunchConfigurations",
                "autoscaling:DescribeTags",
                "autoscaling:SetDesiredCapacity",
                "autoscaling:TerminateInstanceInAutoScalingGroup",
                "ec2:DescribeLaunchTemplateVersions"
            ],
            "Resource": "*"
        }
    ]
}
EOF

#Create the policy in IAM
aws iam create-policy --policy-name AmazonEKSClusterAutoscalerPolicy --policy-document file://cluster-autoscaler-policy.json || true

#Create a service account for the Cluster Autoscaler (IRSA)
eksctl create iamserviceaccount \
  --cluster=$CLUSTER_NAME \
  --namespace=kube-system \
  --name=cluster-autoscaler \
  --role-name AmazonEKSClusterAutoscalerRole \
  --attach-policy-arn=arn:aws:iam::${ACCOUNT_ID}:policy/AmazonEKSClusterAutoscalerPolicy \
  --override-existing-serviceaccounts \
  --approve \
  --region=$AWS_REGION

#Install the Cluster Autoscaler using Helm
helm repo add autoscaler https://kubernetes.github.io/autoscaler
helm upgrade --install cluster-autoscaler autoscaler/cluster-autoscaler \
  -n kube-system \
  --set autoDiscovery.clusterName=$CLUSTER_NAME \
  --set awsRegion=$AWS_REGION \
  --set rbac.serviceAccount.create=false \
  --set rbac.serviceAccount.name=cluster-autoscaler


#Deploy Applications (Namespaces & Apps)

#Create Namespace
kubectl create ns otel-demo

#Deploy OpenTelemetry Demo

kubectl apply -n otel-demo -f opentelemetry-demo.yaml

#Waiting for startup

kubectl get pods -n otel-demo --watch ##Only proceed to the next step after all Pods are Running.

#deploy the final-ingress.yaml to expose the application via ALB

kubectl apply -f final-ingress.yaml

kubectl get ingress -n otel-demo

# Autoscaler Test - Load Test #### Not required for your guys, just for my own reference

kubectl get nodes

kubectl scale deployment load-generator --replicas=20 -n otel-demo

kubectl get pods -n otel-demo | grep Pending

kubectl get nodes -w

kubectl scale deployment load-generator --replicas=1 -n otel-demo




######## Cleanup ########


kubectl delete -f final-ingress.yaml

kubectl delete -f opentelemetry-demo.yaml

kubectl delete ns otel-demo

helm uninstall aws-load-balancer-controller -n kube-system

helm uninstall cluster-autoscaler -n kube-system

eksctl delete iamserviceaccount \
  --cluster=$CLUSTER_NAME \
  --namespace=kube-system \
  --name=aws-load-balancer-controller \
  --region=$AWS_REGION


eksctl delete iamserviceaccount \
  --cluster=$CLUSTER_NAME \
  --namespace=kube-system \
  --name=cluster-autoscaler \
  --region=$AWS_REGION


aws iam delete-policy --policy-arn arn:aws:iam::${ACCOUNT_ID}:policy/AWSLoadBalancerControllerIAMPolicy

aws iam delete-policy --policy-arn arn:aws:iam::${ACCOUNT_ID}:policy/AmazonEKSClusterAutoscalerPolicy

aws cloudformation delete-stack --stack-name ${CLUSTER_NAME}-stack --region $AWS_REGION


# End of File #